{% extends 'layout.html' %}

{% block content %}
    <h2>Importar Usuarios por CSV para Pre-Registro</h2>
    <p>
        Sube un archivo CSV para añadir o actualizar la lista de usuarios autorizados a registrarse en tu organización.
    </p>

    <div style="background-color: #f0f0f0; padding: 1em; border-radius: 5px; margin-bottom: 2em;">
        <h4>Instrucciones para el archivo CSV:</h4>
        <ul>
            <li>El sistema intentará detectar automáticamente la codificación (UTF-8, latin-1, etc.) y el delimitador (coma o punto y coma).</li>
            <li>La primera fila debe ser el encabezado con los nombres de las columnas.</li>
            <li><strong>Columna requerida:</strong> <code>numero_identificacion</code>.</li>
            <li><strong>Columnas opcionales:</strong> <code>email</code>, <code>nombre_completo</code>, <code>rol</code>.</li>
            <li>Para la columna <code>rol</code>, los valores permitidos son: <strong>Profesor, Administrativo, Estudiante</strong>. Si se deja en blanco o el valor es inválido, se asignará 'Estudiante' por defecto.</li>
            <li>El orden de las columnas no importa, pero los nombres deben ser exactos.</li>
        </ul>
        <p>
            Si un número de identificación ya existe en tu organización, sus datos (email, nombre) se actualizarán.
        </p>
    </div>

    <!-- MOSTRAR RESULTADOS DE LA IMPORTACIÓN -->
    {% if success_count is not None %}
        <div style="border: 1px solid #ccc; padding: 1em; margin-bottom: 2em;">
            <h4>Resultados de la Importación</h4>
            <p style="color: green;"><strong>{{ success_count }} de {{ total_rows }} filas procesadas con éxito.</strong></p>
            
            {% if errors %}
                <p style="color: red;"><strong>Se encontraron {{ errors|length }} errores:</strong></p>
                <ul style="max-height: 200px; overflow-y: auto; background-color: #ffebeb; padding: 10px;">
                {% for error in errors %}
                    <li>{{ error }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        </div>
    {% endif %}

    <!-- FORMULARIO DE SUBIDA -->
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Importar Archivo</button>
        <a href="{% url 'users:dashboard' %}" style="margin-left: 1em;">Cancelar</a>
    </form>
{% endblock %}