{% extends 'layout.html' %}
{% load static %}

{% block title %}Editor de Publicación{% endblock %}
{% block container_class %}container-fluid{% endblock %}

{% block content %}
<div class="container-large">
    <div class="glass-card formulario-grande">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
            <div>
                <h1 style="margin-bottom: 0;"><i class="fas fa-pencil-alt"></i> Editor de Publicación</h1>
                <p class="help-text">Construye tu publicación bloque a bloque.</p>
            </div>
        </div>

        <!-- Formulario principal para el título (siempre presente) -->
        <form id="publicacion-main-form" 
            data-pub-id="{{ publicacion.pk }}"
            data-save-url="{% url 'comunicaciones:editar_publicacion_ajax' pk=publicacion.pk %}"
            data-create-block-url="{% url 'comunicaciones:crear_bloque_ajax' pub_pk=publicacion.pk %}">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_titulo">Título de la Publicación</label>
                <input type="text" name="titulo" value="{{ publicacion.titulo }}" required id="id_titulo" class="styled-input">
                <div class="form-grid-2" style="margin-top: 1.5rem;">
                    <div class="form-group">
                        <label for="{{ form.estado.id_for_label }}">Visibilidad</label>
                        {{ form.estado }}
                        <small class="form-help">
                            <b>Borrador:</b> Oculto para todos, solo visible para administradores.<br>
                            <b>Publicado:</b> Visible para el público (inmediatamente o en la fecha programada).
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="{{ form.fecha_publicacion.id_for_label }}">Fecha de Publicación</label>
                        {{ form.fecha_publicacion }}
                        <small class="form-help">{{ form.fecha_publicacion.help_text }}</small>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 1rem;">
                    <label for="{{ form.etiquetas.id_for_label }}">Etiquetas</label>
                    {{ form.etiquetas }}
                    <small class="form-help">{{ form.etiquetas.help_text }}</small>
                </div>
            </div>
            <button type="submit" style="display:none;"></button>
        </form>
        
        <h3 style="margin-top: 2rem; margin-bottom: 1.5rem;"><i class="fas fa-cubes"></i> Contenido por Bloques</h3>

        <!-- Contenedor para los bloques -->
        <div id="block-editor-container" class="block-editor-container">
            {% for bloque in bloques %}
                {% if bloque.tipo == 'texto' %}
                    {% load comunicaciones_tags %}
                    {% include 'comunicaciones/bloques/_texto_form.html' with bloque=bloque form=bloque|get_texto_form %}
                {% else %}
                    {% include 'comunicaciones/bloques/_'|add:bloque.tipo|add:'_form.html' with bloque=bloque %}
                {% endif %}
            {% endfor %}
        </div>

        <!-- Panel para añadir nuevos bloques -->
        <div class="add-block-panel">
            <h4 style="margin-bottom: 1rem; opacity: 0.8;"><i class="fas fa-plus-square"></i> Añadir Bloque:</h4>
            <div class="add-block-buttons">
                <button type="button" class="add-block-btn" data-tipo="texto"><i class="fas fa-paragraph"></i> Texto</button>
                <button type="button" class="add-block-btn" data-tipo="imagen"><i class="fas fa-image"></i> Imagen</button>
                <button type="button" class="add-block-btn" data-tipo="embed"><i class="fas fa-code"></i> Embed</button>
                <button type="button" class="add-block-btn" data-tipo="cita"><i class="fas fa-quote-left"></i> Cita</button>
            </div>
        </div>

        <hr style="margin: 2rem 0; opacity: 0.3;">
        <div style="display: flex; justify-content: flex-end; gap: 1rem;">
            <a href="{% url 'comunicaciones:lista_publicaciones' %}" class="submit-btn" style="background-color: var(--border-color); color: var(--text-color);">
                <i class="fas fa-arrow-left"></i> Volver a Publicaciones
            </a>
            <button type="button" id="manual-save-btn" class="submit-btn">
                <i class="fas fa-save"></i> Guardar Todo
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block body_end %}
<div id="save-status" 
     class="save-status-floating" 
     style="position: fixed; bottom: 30px; right: 30px; z-index: 9999;">
    <i class="fas fa-check-circle"></i> 
    <span>Cambios guardados</span>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
{{ ckeditor_form.media }}
{% include 'comunicaciones/publicacion_script.html' %}
{% endblock %}