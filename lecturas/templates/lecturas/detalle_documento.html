{% extends 'layout.html' %}
{% load auth_extras %}
{% load static %}

{% block title %}{{ documento.titulo }}{% endblock %}

{% block content %}
<div class="container">
    <!-- BOTONES PROFESIONALES -->
    <div class="acciones-documento">
        {% if user|has_group:"Profesor" or user|has_group:"Administrativo" %}
            <a href="{% url 'lecturas:subir_documento' %}" class="btn-subir-archivo">
                <i class="fas fa-plus"></i>
                Nueva Lectura
            </a>
        {% else %}
            <div></div>
        {% endif %}
        
        <button id="btn-enter-focus" class="btn-modo-concentracion">
            <i class="fas fa-eye"></i>
            Modo Concentraci√≥n
        </button>
    </div>

    <!-- BOT√ìN PARA SALIR -->
    <button id="btn-exit-focus" class="submit-btn">
        <i class="fas fa-times"></i>
        Salir del Modo Concentraci√≥n
    </button>

    <!-- SECCI√ìN PRINCIPAL DE LA LECTURA -->
    <article id="lectura-container" class="glass-card tema-original lectura-fullscreen">
        <div class="rating-dropdown-wrapper">
            <!-- El disparador que siempre est√° visible -->
            <button class="rating-trigger">
                <i class="fas fa-star"></i>
                <span>{{ documento.calificacion_promedio }}</span>
            </button>

            <!-- El panel que se despliega (contiene el sistema de calificaci√≥n anterior) -->
            <div class="rating-dropdown-panel">
                <div class="average-rating">
                    <h4>Calificaci√≥n Promedio</h4>
                    <div class="star-rating-display" title="{{ documento.calificacion_promedio }} de 5 estrellas"></div>
                    <div style="margin-top: 0.5rem;">
                        <span id="average-score-text">{{ documento.calificacion_promedio }}</span><span style="font-size: 0.9rem; opacity: 0.6;">/5</span>
                    </div>
                    <small>(<span id="total-ratings-text">{{ documento.num_calificaciones }}</span> voto{{ documento.num_calificaciones|pluralize:"s" }})</small>
                </div>
                
                {% if user.is_authenticated %}
                    <div class="user-rating-input">
                        <hr style="margin: 0.75rem 0; opacity: 0.3;">
                        <h5>Tu Voto:</h5>
                        <div class="star-rating-input" data-url="{% url 'lecturas:calificar_documento_ajax' pk=documento.pk %}">
                            <i class="fas fa-star star" data-value="5"></i>
                            <i class="fas fa-star star" data-value="4"></i>
                            <i class="fas fa-star star" data-value="3"></i>
                            <i class="fas fa-star star" data-value="2"></i>
                            <i class="fas fa-star star" data-value="1"></i>
                        </div>
                        <small id="user-rating-feedback" style="display:none; color: var(--accent-color); margin-top: 0.5rem;">¬°Gracias!</small>
                    </div>
                {% endif %}
            </div>
        </div>
        <header class="page-header">
            <h1>{{ documento.titulo }}</h1>
            <p>
                <small>
                    {% if documento.autor_principal %}
                        <strong>Autor:</strong> {{ documento.autor_principal.nombre }} |
                    {% endif %}
                    <strong>Grado:</strong> {{ documento.get_grado_display }} |
                    <strong>Subido por:</strong> {{ documento.author.username }} |
                    <strong>Fecha:</strong> {{ documento.date|date:"d M, Y" }}
                </small>
            </p>
            
            {% if documento.generos.all %}
            <div class="generos-container" style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                {% for genero in documento.generos.all %}
                    <span class="genero-tag" style="background-color: var(--border-color); padding: 0.35rem 0.85rem; border-radius: 15px; font-size: 0.85rem;">
                        <i class="fas fa-tag" style="font-size: 0.75rem; opacity: 0.7;"></i>
                        {{ genero.nombre }}
                    </span>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if user == documento.author or user.is_superuser or user|has_group:"Administrativo" %}
                <div class="respuesta-acciones" style="border-top: none; padding-top: 1rem; margin-top: 1rem;">
                    <a href="{% url 'lecturas:editar_documento' pk=documento.pk %}" class="btn-adjunto">
                        <i class="fas fa-edit"></i> Editar Publicaci√≥n
                    </a>
                    <a href="{% url 'lecturas:borrar_documento' pk=documento.pk %}" class="btn-adjunto" style="background-color: #ff4757; color: white; border-color: #ff4757;">
                        <i class="fas fa-trash"></i> Borrar Publicaci√≥n
                    </a>
                </div>
            {% endif %}
        </header>

        <!-- IMAGEN DEL DOCUMENTO -->
        {% if documento.imagen %}
            <div class="documento-imagen">
                <img src="{{ documento.imagen.url }}" alt="Imagen del documento {{ documento.titulo }}">
            </div>
        {% endif %}

        <!-- CONTENIDO PRINCIPAL -->
        <div class="contenido-post">
            {{ documento.descripcion|safe }}
        </div>

        <!-- Clearfix para el float -->
        <div style="clear: both;"></div>

        <!-- VISUALIZADOR DE ARCHIVOS -->
        {% if documento.adjunto %}
            <div style="margin-top: 3rem; text-align: center;">
                <h3>Documento Adjunto</h3>
                {% with ext=documento.adjunto.name|lower %}
                    {% if '.pdf' in ext %}
                        <div style="position: relative; height: 600px; border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; margin-top: 1rem;">
                            <iframe src="{% url 'lecturas:serve_file' pk=documento.pk %}" 
                                    style="width: 100%; height: 100%; border: none;"
                                    title="Visualizador de PDF: {{ documento.titulo }}">
                            </iframe>
                        </div>
                    {% else %}
                        <a href="{% url 'lecturas:serve_file' pk=documento.pk %}" class="btn-subir-archivo" target="_blank" style="margin-top: 1rem;">
                            <i class="fas fa-download"></i>
                            Descargar {{ documento.adjunto.name|slice:"-30:" }}
                        </a>
                    {% endif %}
                {% endwith %}
            </div>
        {% endif %}
    </article>

    <hr style="margin: 3rem 0;">

    <!-- SECCI√ìN DE PARTICIPACIONES -->
    <div id="comentarios-container">
        <h3>
            <i class="fas fa-comments"></i>
            Participaciones ({{ comentarios_page.paginator.count }})
        </h3>

        <!-- FORMULARIO DE COMENTARIOS -->
        {% if user.is_authenticated %}
            <div class="form-comentario-compacto">
                <form id="main-comment-form" method="post" action="{% url 'lecturas:anadir_comentario' pk=documento.pk %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        {{ comentario_form.contenido }}
                    </div>

                    <div class="adjuntos-container">
                        <label class="btn-adjunto">
                            <i class="fas fa-paperclip"></i>
                            Adjuntar archivo
                            {{ comentario_form.adjunto_comentario }}
                        </label>

                        <label class="btn-adjunto">
                            <i class="fas fa-image"></i>
                            Adjuntar imagen
                            {{ comentario_form.imagen_comentario }}
                        </label>

                        <button type="submit" class="btn-envio-compacto">
                            <i class="fas fa-paper-plane"></i>
                            Publicar
                        </button>
                    </div>

                    <div class="form-help">
                        <small>Archivos: PDF, DOC, DOCX, EPUB (m√°x. 8MB) | Im√°genes: JPG, PNG, WEBP (m√°x. 2MB)</small>
                    </div>
                </form>
            </div>
        {% else %}
            <div class="login-prompt">
                <div class="login-message">
                    <h3>¬°√önete a la conversaci√≥n!</h3>
                    <p>Necesitas iniciar sesi√≥n para poder dejar tu participaci√≥n en esta lectura.</p>
                    <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn-login">
                        <i class="fas fa-sign-in-alt"></i>
                        Iniciar Sesi√≥n
                    </a>
                </div>
            </div>
        {% endif %}

        <!-- LISTA DE COMENTARIOS -->
        <div id="comments-list">
            {% for comentario in comentarios_page %}
                {% include 'lecturas/_comentario_item.html' with comentario=comentario documento=documento %}
            {% empty %}
                <p style="text-align: center; padding: 2rem; color: var(--text-color); opacity: 0.7;">
                    <i class="fas fa-comment-slash"></i><br>
                    A√∫n no hay participaciones. ¬°S√© el primero en comentar!
                </p>
            {% endfor %}
        </div>
        {% include 'partials/pagination.html' %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SCRIPTS -->
{% include 'lecturas/calificacion_script.html' %}
{% include 'lecturas/focus_mode_script.html' %}
{% include 'lecturas/comentario_sistema_script.html' %}

<script>
    // Sistema de colapsar/expandir hijos
    document.addEventListener('click', function(e) {
        const toggleBtn = e.target.closest('.toggle-hijos-btn');
        if (toggleBtn) {
            e.preventDefault();
            const hijosContent = toggleBtn.nextElementSibling;
            const icon = toggleBtn.querySelector('i');
            
            if (hijosContent && hijosContent.classList.contains('hijos-content')) {
                hijosContent.classList.toggle('visible');
                
                if (hijosContent.classList.contains('visible')) {
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                    toggleBtn.innerHTML = '<i class="fas fa-minus-square"></i> Ocultar respuestas';
                } else {
                    icon.classList.remove('fa-minus-square');
                    icon.classList.add('fa-plus-square');
                    const count = hijosContent.children.length;
                    toggleBtn.innerHTML = `<i class="fas fa-plus-square"></i> Ver ${count} respuesta${count > 1 ? 's' : ''}`;
                }
            }
        }
    });

    // Inicializaci√≥n mejorada de CKEditor
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîÑ Inicializando sistema de comentarios...');
        
        // Esperar a que CKEditor est√© listo
        function waitForCKEditor(callback, maxAttempts = 10) {
            let attempts = 0;
            const checkInterval = setInterval(() => {
                attempts++;
                if (window.CKEDITOR_5_INSTANCES && Object.keys(window.CKEDITOR_5_INSTANCES).length > 0) {
                    clearInterval(checkInterval);
                    console.log('‚úÖ CKEditor listo despu√©s de', attempts, 'intentos');
                    callback();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    console.warn('‚ùå CKEditor no se inicializ√≥ despu√©s de', maxAttempts, 'intentos');
                }
            }, 500);
        }

        waitForCKEditor(function() {
            console.log('üéØ Aplicando tema inicial a CKEditor');
            const isDarkMode = document.body.classList.contains('dark-mode');
            if (window.applyThemeToCKEditorInstances) {
                window.applyThemeToCKEditorInstances(isDarkMode);
            }
        });
    });
</script>
{% endblock %}