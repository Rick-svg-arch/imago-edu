{% extends 'layout.html' %}

{% block container_class %}container-fluid{% endblock %}

{% block content %}
<h1>Gesti√≥n de Usuarios Pre-registrados</h1>

<!-- BLOQUE DE MENSAJES - A√ëADIDO AQU√ç -->
{% if messages %}
<div class="messages-container" style="margin-bottom: 20px;">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {% if message.tags == 'success' %}
            <strong>‚úì √âxito:</strong>
        {% elif message.tags == 'error' %}
            <strong>‚úó Error:</strong>
        {% elif message.tags == 'warning' %}
            <strong>‚ö† Advertencia:</strong>
        {% else %}
            <strong>‚Ñπ Info:</strong>
        {% endif %}
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="manager-grid">
    <!-- Columna Izquierda: Lista y B√∫squeda -->
    <div class="list-section glass-card">
        <h3>Whitelist Actual</h3>
        <form method="get" style="display: flex; gap: 10px; margin-bottom: 1em;">
            <input type="text" name="q" placeholder="Buscar..." value="{{ request.GET.q|default_if_none:'' }}">
            <button type="submit" class="btn btn-primary">Buscar</button>
        </form>
        <hr>
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for preregistro in preregistros %}
                    <tr>
                        <td>{{ preregistro.numero_identificacion }}</td>
                        <td>{{ preregistro.nombre_completo|default:"N/A" }}</td>
                        <td>{{ preregistro.email|default:"N/A" }}</td>
                        <td>{{ preregistro.get_rol_asignado_display }}</td>
                        <td>
                            {% if preregistro.registrado %}
                                <span class="badge bg-success">Registrado</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">Pendiente</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'users:preregistro_edit' pk=preregistro.pk %}" class="btn btn-sm btn-outline-primary">Editar</a>
                            <a href="{% url 'users:preregistro_delete' pk=preregistro.pk %}" class="btn btn-sm btn-outline-danger">Borrar</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="text-center text-muted">No se encontraron usuarios.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% include 'partials/pagination.html' %}
    </div>

    <!-- Columna Derecha: Formularios de Adici√≥n -->
    <div class="actions-section">
        <!-- Formulario para A√±adir Manualmente -->
        <div class="form-section glass-card">
            <h4>A√±adir Manualmente</h4>
            <form method="post">
                {% csrf_token %}
                {{ manual_form.as_p }}
                <button type="submit" name="submit_manual" class="btn btn-primary">A√±adir Usuario</button>
            </form>
        </div>
        <br>
        <!-- Formulario para Importar por CSV -->
        <div class="form-section glass-card">
            <h4>Importar por CSV</h4>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {{ csv_form.as_p }}
                <small class="form-text text-muted">
                    El archivo debe tener la columna <strong>numero_identificacion</strong>.<br>
                    Las columnas <strong>email, nombre_completo y rol</strong> son opcionales.<br>
                    La columna <strong>rol</strong> acepta: <code>Administrativo</code>, <code>Profesor</code> y <code>Estudiante</code><br>
                    La primera fila debe tener los nombres exactos de las columnas.
                </small>
                <button type="submit" name="submit_csv" class="btn btn-primary mt-2">Importar Archivo</button>
            </form>
            
            <!-- Mostrar errores del CSV en detalle (adem√°s de los mensajes globales) -->
            {% if csv_errors %}
                <div class="alert alert-danger mt-3">
                    <h5><strong>Detalles de errores en el CSV:</strong></h5>
                    <ul style="max-height: 300px; overflow-y: auto;">
                        {% for error in csv_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="{% url 'users:historial_importaciones' %}" class="btn btn-secondary">üìä Ver Historial de Importaciones</a>
</div>

<br>
<a href="{% url 'users:dashboard' %}">‚Üê Volver al Panel de Control</a>

<style>
.manager-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

@media (max-width: 992px) {
    .manager-grid {
        grid-template-columns: 1fr;
    }
}

.glass-card {
    border-radius: 10px;
    padding: 20px;
}

.alert {
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}

.table {
    border-radius: 8px;
    overflow: hidden;
}

.badge {
    padding: 5px 10px;
    border-radius: 12px;
    font-size: 0.85em;
}
</style>
{% endblock %}