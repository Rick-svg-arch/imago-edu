{% extends 'layout.html' %}
{% load auth_extras %}
{% load static %}

{% block container_class %}container-fluid{% endblock %}

{% block title %}Lista de Lecturas{% endblock %}

{% block content %}
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <h1><i class="fas fa-book-reader"></i> Biblioteca de Lecturas</h1>
        {% if user|has_group:"Profesor" or user|has_group:"Administrativo" %}
            <a href="{% url 'lecturas:subir_documento' %}" class="submit-btn"><i class="fas fa-plus"></i> Subir Nueva Lectura</a>
        {% endif %}
    </div>

    <!-- Contenedor principal: Sidebar y Contenido -->
    <div class="sidebar-layout">
        
        <!-- ===== COLUMNA DE LA BARRA LATERAL (SIDEBAR) ===== -->
        <aside class="sidebar category-filter">
            <h3 style="margin-top: 0;"><i class="fas fa-filter"></i> Filtros y Búsqueda</h3>
                
                <!-- BÚSQUEDA GENERAL -->
            <form method="get" id="filter-form">
                <div class="form-group" style="margin-bottom: 2rem;">
                    <label for="id_q" style="font-weight: bold; display: block; margin-bottom: 0.5rem;">
                        <i class="fas fa-search"></i> Búsqueda por palabra clave
                    </label>
                    <!-- Nuestro nuevo contenedor ancla -->
                    <div class="search-input-wrapper">
                        <input type="search" id="id_q" name="q" 
                            placeholder="Título, autor o género..." 
                            value="{{ request.GET.q|default_if_none:'' }}" 
                            class="styled-search-input">
                        <button type="submit" class="search-submit-btn" aria-label="Buscar">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <hr style="opacity: 0.3;">
                
                <!-- FILTROS DE IDIOMA/GRADO (TU CÓDIGO ORIGINAL) -->
                <h4 style="margin-bottom: 1rem;"><i class="fas fa-language"></i> Idioma & Grado</h4>
                <a href="{% url 'lecturas:lista_documentos_base' %}" class="submit-btn" style="width: 100%; justify-content: center; margin-bottom: 1rem;">
                    Mostrar Todos
                </a>

                <ul style="list-style: none; padding: 0;">
                    {% for code, name in lista_idiomas %}
                    <li class="language-item" style="margin-bottom: 0.5rem;">
                        <a class="language-toggle" data-target="#grades-{{ code }}">{{ name }}</a>
                        
                        <ul class="grade-list" id="grades-{{ code }}" style="display: none; list-style: none; padding-left: 1rem;">
                            <li style="margin-top: 0.5rem;">
                                <a href="{% url 'lecturas:lista_por_idioma' idioma=code %}" style="font-weight: bold;">Todos los {{ name }}</a>
                            </li>
                            {% for grado_code, grado_name in lista_grados %}
                            <li>
                                <a href="{% url 'lecturas:lista_documentos_filtrada' idioma=code grado=grado_code %}">
                                    {{ grado_name }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endfor %}
                </ul>
                
                <!-- BOTÓN OCULTO PARA SUBMIT (si se añaden más campos al form) -->
                <button type="submit" style="display: none;"></button>
            </form>
        </aside>

        <!-- ===== COLUMNA DEL CONTENIDO PRINCIPAL ===== -->
        <main class="main-content">
            <h3>
            {% if current_idioma %}
                Mostrando: <strong>{{ current_idioma|capfirst }}</strong>
                {% if current_grado %} - <strong>{{ current_grado|capfirst }}</strong>{% endif %}
            {% else %}
                Todos los Documentos ({{ documentos.paginator.count }})
            {% endif %}
            </h3>

            {% if documentos %}
                
                <!-- ================== VISTA TIPO TARJETA ================== -->
                <div class="lectura-card-grid">
                    {% for doc in documentos %}
                        <a href="{% url 'lecturas:detalle_documento' pk=doc.pk %}" class="lectura-card">
                            
                            <!-- Imagen de la tarjeta -->
                            <div class="lectura-card-image-wrapper">
                                {% if doc.imagen %}
                                    <img src="{{ doc.imagen.url }}" alt="Imagen de {{ doc.titulo }}" loading="lazy">
                                {% else %}
                                    {# Asegúrate de que la ruta a tu imagen por defecto es correcta #}
                                    <img src="{% static 'images/lectura.jpg' %}" alt="Sin imagen" loading="lazy">
                                {% endif %}
                                <div class="card-overlay">
                                    <i class="fas fa-expand-alt"></i> Ver Detalle
                                </div>
                            </div>
                            <!-- Contenido de la tarjeta -->
                            <div class="lectura-card-content">
                                <h4 class="card-title">{{ doc.titulo }}</h4>
                                
                                <div class="card-meta">
                                    <span class="meta-item"><i class="fas fa-user-edit"></i> {{ doc.autor_principal.nombre|default:doc.author.username }}</span>
                                    <span class="meta-item"><i class="fas fa-graduation-cap"></i> {{ doc.get_grado_display }}</span>
                                </div>
                                
                                <div class="card-tags">
                                    {% for genero in doc.generos.all|slice:":2" %}
                                        <span class="genero-tag">{{ genero.nombre }}</span>
                                    {% endfor %}
                                </div>
                                
                                <div class="card-rating">
                                    <!-- Utilizamos Font Awesome para las estrellas -->
                                    {% with rating=doc.calificacion_promedio %}
                                        {% for i in "12345"|make_list %}
                                            {% if forloop.counter <= rating %}
                                                <i class="fas fa-star filled"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    {% endwith %}
                                    <small>({{ doc.num_calificaciones }} votos)</small>
                                </div>
                            </div>
                        </a>
                    {% endfor %}
                </div>
                <!-- ================== FIN VISTA TIPO TARJETA ================== -->

            {% else %}
                <p class="no-results-message">
                    <i class="fas fa-search-minus"></i> No se encontraron documentos que coincidan con los filtros o la búsqueda.
                </p>
            {% endif %}
            
            {% include 'partials/pagination.html' %}
        </main>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Lógica de alternar sub-listas de grados
        const languageToggles = document.querySelectorAll('.language-toggle');

        languageToggles.forEach(toggle => {
            toggle.addEventListener('click', function(event) {
                event.preventDefault(); 
                
                // Usamos el data-target para encontrar la lista de grados correspondiente
                const targetId = this.dataset.target;
                const gradeList = document.querySelector(targetId);
                
                if (gradeList) {
                    // Alterna la clase 'active' para mostrar u ocultar
                    gradeList.classList.toggle('active');

                    // Lógica para deslizar (opcional, si tienes un CSS que maneje .active)
                    if (gradeList.classList.contains('active')) {
                        gradeList.style.display = 'block';
                    } else {
                        gradeList.style.display = 'none';
                    }
                }
            });
        });
    });
</script>
{% endblock %}