<script>
class ForumSystem {
    constructor() {
        // Asegurarse de que el token exista antes de intentar leer .value
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        this.csrfToken = csrfTokenElement ? csrfTokenElement.value : '';
        this.init();
    }

    init() {
        document.body.addEventListener('submit', e => this.handleFormSubmit(e));
        document.body.addEventListener('click', e => this.handleClick(e));
        document.body.addEventListener('change', e => {
            if (e.target.matches('input[type="file"][name="banner"]')) {
                this.handleFilePreview(e.target);
            }
        });
    }

    handleFilePreview(fileInput) {
        const form = fileInput.closest('form');
        if (!form) return;
        const previewContainer = form.querySelector('.selected-files-preview');
        if (!previewContainer) return;

        const file = fileInput.files[0];

        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewContainer.innerHTML = `
                    <div class="preview-item">
                        <img src="${e.target.result}" alt="Vista previa" class="preview-image">
                        <div class="preview-info">
                            <span class="preview-name">${file.name}</span>
                            <span class="preview-size">${(file.size / 1024).toFixed(1)} KB</span>
                        </div>
                        <button type="button" class="clear-preview-btn" title="Quitar imagen">&times;</button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        } else {
            // Si el usuario cancela la selección de archivo, limpiamos la preview
            previewContainer.innerHTML = '';
        }
    }

    async handleFormSubmit(e) {
        const form = e.target.closest('.ajax-response-form, .ajax-edit-form');
        if (!form) return;

        e.preventDefault();
        if (form.dataset.submitting === 'true') return;
        form.dataset.submitting = 'true';

        const submitBtn = form.querySelector('button[type="submit"]');
        const originalBtnHTML = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        submitBtn.disabled = true;

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': this.csrfToken }
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Error en el servidor.');

            if (data.success) {
                if (form.matches('.ajax-edit-form')) {
                    const respuestaItem = form.closest('.respuesta-item');
                    if (respuestaItem) respuestaItem.outerHTML = data.html;
                } else {
                    this.handleNewResponse(data, form);
                }
                this.showMessage('¡Acción completada con éxito!', 'success');
            } else {
                throw new Error(data.error || 'Error desconocido.');
            }
        } catch (error) {
            this.showMessage(error.message, 'error');
        } finally {
            submitBtn.innerHTML = originalBtnHTML;
            submitBtn.disabled = false;
            delete form.dataset.submitting;
        }
    }
    
    handleNewResponse(data, form) {
        if (data.is_nested) {
            const parentContainer = document.getElementById(`hijos-container-${data.parent_id}`);
            if (parentContainer) {
                let childrenContent = parentContainer.querySelector('.children-content');
                if (!childrenContent) {
                    childrenContent = document.createElement('div');
                    childrenContent.className = 'children-content';
                    parentContainer.appendChild(childrenContent);
                }
                childrenContent.insertAdjacentHTML('beforeend', data.html);
            }
        } else {
            const commentsSection = document.getElementById('comments-section');
            // Quitar el mensaje de "no hay respuestas" si existe
            const noRepliesMessage = commentsSection.querySelector('.no-replies-message');
            if(noRepliesMessage) noRepliesMessage.remove();
            
            commentsSection.insertAdjacentHTML('afterbegin', data.html);
        }
        form.reset();
        const previewContainer = form.querySelector('.selected-files-preview');
        if (previewContainer) previewContainer.innerHTML = '';
        
        const formContainer = form.closest('.reply-form-container');
        if (formContainer) formContainer.style.display = 'none';
        
        if (form.closest('.respuesta-principal-form')) {
            const editor = window.CKEDITOR_5_INSTANCES && window.CKEDITOR_5_INSTANCES['id_contenido'];
            if(editor) editor.setData('');
        }
    }

    handleClick(e) {
        const clearPreviewBtn = e.target.closest('.clear-preview-btn');
        if (clearPreviewBtn) {
            e.preventDefault();
            const form = clearPreviewBtn.closest('form');
            if (form) {
                const fileInput = form.querySelector('input[type="file"][name="banner"]');
                const previewContainer = form.querySelector('.selected-files-preview');

                if (fileInput) fileInput.value = ''; 
                
                if (previewContainer) previewContainer.innerHTML = '';
            }
            return;
        }
        const replyBtn = e.target.closest('.reply-btn');
        const cancelEditBtn = e.target.closest('.cancel-edit-btn');
        const editBtn = e.target.closest('.edit-reply-btn');
        const deleteBtn = e.target.closest('.delete-reply-btn');
        const cancelReplyBtn = e.target.closest('.cancel-reply-btn');
        const toggleBtn = e.target.closest('.toggle-hijos-btn');

        if (replyBtn) {
            e.preventDefault();
            const formContainer = document.getElementById(`reply-form-${replyBtn.dataset.id}`);
            if (formContainer) {
                const isHidden = formContainer.style.display === 'none';
                document.querySelectorAll('.reply-form-container').forEach(fc => fc.style.display = 'none');
                formContainer.style.display = isHidden ? 'block' : 'none';
            }
            return;
        }

        if (cancelEditBtn) {
            e.preventDefault();
            const wrapper = cancelEditBtn.closest('.respuesta-contenido-wrapper');
            if (wrapper && wrapper.dataset.originalHtml) {
                wrapper.innerHTML = wrapper.dataset.originalHtml;
            }
            return;
        }

        if (cancelReplyBtn) {
            e.preventDefault();
            const formContainer = cancelReplyBtn.closest('.reply-form-container');
            if (formContainer) {
                formContainer.style.display = 'none';
            }
            return;
        }

        if (editBtn) {
            e.preventDefault();
            this.handleEditClick(editBtn);
            return;
        }
        
        if (deleteBtn) {
            e.preventDefault();
            this.handleDeleteClick(deleteBtn);
            return;
        }
        if (toggleBtn) {
            e.preventDefault();
            this.handleToggleChildren(toggleBtn);
            return;
        }
    }

    async handleToggleChildren(toggleBtn) {
        const parentId = toggleBtn.dataset.parentId;
        const hijosContainer = document.getElementById(`hijos-container-${parentId}`);
        if (!hijosContainer) return;

        const isLoaded = toggleBtn.dataset.loaded === 'true';

        if (isLoaded) {
            // Si ya están cargados, solo los ocultamos/mostramos
            const childrenContent = hijosContainer.querySelector('.children-content');
            if (childrenContent) {
                const isHidden = childrenContent.style.display === 'none';
                childrenContent.style.display = isHidden ? 'block' : 'none';
                // Actualizamos el texto y el icono del botón
                toggleBtn.innerHTML = isHidden 
                    ? `<i class="fas fa-minus-square"></i> Ocultar respuestas` 
                    : `<i class="fas fa-plus-square"></i> Ver ${childrenContent.children.length} respuesta(s)`;
            }
        } else {
            // Si no están cargados, los pedimos por AJAX
            const originalHtml = toggleBtn.innerHTML;
            toggleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
            toggleBtn.disabled = true;
            
            try {
                // Usamos data-url en lugar de href
                const response = await fetch(toggleBtn.dataset.url);
                const data = await response.json();
                
                const newChildrenContent = document.createElement('div');
                newChildrenContent.className = 'children-content';
                newChildrenContent.innerHTML = data.html;
                hijosContainer.appendChild(newChildrenContent);
                
                toggleBtn.innerHTML = `<i class="fas fa-minus-square"></i> Ocultar respuestas`;
                toggleBtn.dataset.loaded = 'true';
                toggleBtn.disabled = false;
            } catch (error) {
                console.error('Error al cargar respuestas:', error);
                this.showMessage('No se pudieron cargar las respuestas.', 'error');
                loadBtn.innerHTML = originalHtml;
                loadBtn.disabled = false;
            }
        }
    }

    async handleEditClick(editBtn) {
        const wrapper = editBtn.closest('.respuesta-contenido-wrapper');
        if (!wrapper) return;
        wrapper.dataset.originalHtml = wrapper.innerHTML;
        wrapper.innerHTML = '<div style="padding: 2rem; text-align: center;"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>';
        
        try {
            const response = await fetch(editBtn.dataset.url);
            const data = await response.json();
            wrapper.innerHTML = data.html;
            this.initializeEditFormWidgets(wrapper.querySelector('.ajax-edit-form'));
        } catch (error) {
            wrapper.innerHTML = wrapper.dataset.originalHtml;
        }
    }

    async handleDeleteClick(deleteBtn) {
        if (!confirm('¿Estás seguro de que quieres borrar esta respuesta?')) return;
        try {
            const response = await fetch(deleteBtn.dataset.url, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': this.csrfToken }
            });
            const data = await response.json();
            if (data.success) {
                const respuestaItem = deleteBtn.closest('.respuesta-item');
                respuestaItem.style.transition = 'opacity 0.5s, transform 0.5s';
                respuestaItem.style.opacity = '0';
                respuestaItem.style.transform = 'scale(0.95)';
                setTimeout(() => respuestaItem.remove(), 500);
            } else { throw new Error(data.error); }
        } catch (error) {
            this.showMessage('No se pudo borrar la respuesta.', 'error');
        }
    }

    initializeEditFormWidgets(formElement) {
        const respuestaId = formElement.action.match(/(\d+)/g).pop();
        if (!respuestaId) return;

        const widgetContainer = formElement.querySelector(`#django-banner-widget-container-${respuestaId}`);
        if (!widgetContainer) return;

        const fileInput = widgetContainer.querySelector('input[type="file"]');
        const clearCheckbox = widgetContainer.querySelector('input[type="checkbox"]');
        const currentLink = widgetContainer.querySelector('a');

        const previewContainer = formElement.querySelector(`#banner-preview-container-${respuestaId}`);
        const clearContainer = formElement.querySelector(`#banner-clear-container-${respuestaId}`);
        const triggerBtn = formElement.querySelector(`#banner-trigger-btn-${respuestaId}`);
        const btnText = formElement.querySelector(`#banner-btn-text-${respuestaId}`);

        if (!fileInput || !previewContainer || !clearContainer || !triggerBtn || !btnText) return;

        // Si ya hay un banner, mostramos la imagen actual y ajustamos el botón
        if (currentLink && currentLink.href) {
            previewContainer.innerHTML = `<img src="${currentLink.href}" alt="Banner actual" style="width: 100%; border-radius: 8px;">`;
            btnText.textContent = 'Cambiar banner';
        }

        // Movemos el checkbox "Limpiar" para que sea visible
        if (clearCheckbox) {
            const clearLabel = document.createElement('label');
            clearLabel.style.fontSize = '0.85rem';
            clearLabel.style.opacity = '0.8';
            clearLabel.appendChild(clearCheckbox);
            clearLabel.append(' Eliminar banner actual');
            clearContainer.appendChild(clearLabel);
        }

        // Conectamos nuestro botón personalizado al input de archivo real (que está oculto)
        triggerBtn.addEventListener('click', () => fileInput.click());

        // Cuando se selecciona un archivo nuevo, ocultamos el checkbox "Limpiar"
        fileInput.addEventListener('change', () => {
            if (clearContainer) {
                clearContainer.style.display = 'none';
            }
        });
    }
    
    // ================== CÓDIGO CORREGIDO Y COMPLETO ==================
    showMessage(message, type = 'info') {
        const styles = {
            success: 'background: #10b981;',
            error: 'background: #ef4444;',
            info: 'background: #3b82f6;'
        };
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
            position: fixed; top: 100px; right: 20px; ${styles[type] || styles.info}
            color: white; padding: 1rem 1.5rem; border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        messageDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i> <strong>${message}</strong>`;
        document.body.appendChild(messageDiv);

        setTimeout(() => {
            messageDiv.style.animation = 'slideOut 0.3s ease forwards';
            messageDiv.addEventListener('animationend', () => messageDiv.remove());
        }, 3000);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // Añadir estilos para las animaciones de los mensajes
    const styles = `@keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } } @keyframes slideOut { from { transform: translateX(0); } to { transform: translateX(120%); } }`;
    const styleSheet = document.createElement('style');
    styleSheet.textContent = styles;
    document.head.appendChild(styleSheet);
    
    new ForumSystem();
});
</script>