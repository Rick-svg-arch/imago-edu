{% extends 'layout.html' %}
{% block content %}
<div class="container-large">
    <div class="glass-card formulario-grande">
        <h1>{% if object %}Editar Clase: {{ object.nombre }}{% else %}Crear Nueva Clase{% endif %}</h1>
        <form method="post" enctype="multipart/form-data" class="form-container" style="padding:0; border:none; box-shadow:none;">
            {% csrf_token %}
            <div class="form-grid-2">
                <div class="form-group">{{ form.nombre.label_tag }}{{ form.nombre }}</div>
                {% if form.profesor %}<div class="form-group">{{ form.profesor.label_tag }}{{ form.profesor }}</div>{% endif %}
            </div>
            <div class="form-group">
                {{ form.estudiantes_por_id.label_tag }}
                <small class="help-text">
                    Ingresa los n√∫meros de identificaci√≥n separados por comas o espacios. Ejemplo: 12345678, 87654321, 11223344
                </small>
                {{ form.estudiantes_por_id }}
                <button type="button" id="btn-preview-ids" class="submit-btn" style="margin-top:0.5rem;">Buscar y A√±adir</button>
            </div>
            <div id="preview-results"></div>
            <div class="form-group">{{ form.estudiantes_csv.label_tag }}{{ form.estudiantes_csv }}<button type="button" id="btn-preview-csv" class="submit-btn" style="margin-top:0.5rem;">Previsualizar</button></div>
            <div id="csv-preview-results"></div>
            <fieldset class="dual-selector-fieldset">
                <legend>Selecci√≥n de Estudiantes</legend>
                
                <div class="selector-container">
                    <!-- Columna Izquierda: Estudiantes Disponibles con B√∫squeda -->
                    <div class="selector-column">
                        <label for="student-search">Filtrar Disponibles</label>
                        <input type="search" id="student-search" class="selector-search" placeholder="Buscar por nombre, usuario o ID...">
                        <select id="available-students" multiple></select>
                    </div>

                    <!-- Columna Central: Botones de Acci√≥n -->
                    <div class="selector-buttons">
                        <button type="button" id="btn-add" title="Inscribir seleccionados"><i class="fas fa-arrow-right"></i></button>
                        <button type="button" id="btn-remove" title="Quitar seleccionados"><i class="fas fa-arrow-left"></i></button>
                    </div>

                    <!-- Columna Derecha: Estudiantes Inscritos -->
                    <div class="selector-column">
                        <label for="id_estudiantes">Inscritos</label>
                        {{ form.estudiantes }}
                    </div>
                </div>
            </fieldset>
            <div style="display: flex; gap: 1rem; margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 2rem;">
                <button type="submit" class="submit-btn">Guardar</button>
                <a href="{% url 'users:dashboard' %}" class="submit-btn" style="background-color: var(--border-color); color: var(--text-color);">Cancelar</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variable global para mantener TODAS las opciones disponibles
    let todasLasOpcionesDisponibles = [];
    let chosenSelectGlobal = null;

    // FUNCI√ìN GLOBAL: Mantener siempre seleccionadas todas las opciones en chosenSelect
    function mantenerSeleccionadas() {
        if (chosenSelectGlobal) {
            Array.from(chosenSelectGlobal.options).forEach(option => {
                option.selected = true;
            });
        }
    }

    // --- FUNCI√ìN 1: MANEJA EL SELECTOR DE DOS CAJAS (CORREGIDA) ---
    function setupStudentSelector() {
        const availableSelect = document.getElementById('available-students');
        const chosenSelect = document.getElementById('id_estudiantes');
        const btnAdd = document.getElementById('btn-add');
        const btnRemove = document.getElementById('btn-remove');
        const form = document.querySelector('form');

        if (!availableSelect || !chosenSelect || !btnAdd || !btnRemove) {
            console.error("Faltan elementos para el selector de estudiantes.");
            return;
        }

        // Guardar referencia global
        chosenSelectGlobal = chosenSelect;

        chosenSelect.classList.add('selector-box');
        
        // Guardamos todas las opciones originales
        const allOptions = Array.from(chosenSelect.options);
        chosenSelect.innerHTML = '';

        // Separamos entre disponibles e inscritos
        allOptions.forEach(option => {
            const optionClone = option.cloneNode(true);
            if (option.selected) {
                chosenSelect.appendChild(option);
            } else {
                availableSelect.appendChild(option);
                // Guardamos una copia para el filtro
                todasLasOpcionesDisponibles.push(optionClone);
            }
        });

        // SOLUCI√ìN: Mantener siempre seleccionadas todas las opciones en chosenSelect
        function mantenerSeleccionadas() {
            Array.from(chosenSelect.options).forEach(option => {
                option.selected = true;
            });
        }

        // Ejecutar cada vez que cambie el contenido
        const observer = new MutationObserver(mantenerSeleccionadas);
        observer.observe(chosenSelect, { childList: true, subtree: true });
        
        // Ejecutar inicialmente
        mantenerSeleccionadas();

        function moveOptions(source, destination) {
            const selectedOptions = Array.from(source.selectedOptions);
            selectedOptions.forEach(option => {
                const optionClone = option.cloneNode(true);
                // IMPORTANTE: Al mover a inscritos, clonar sin la propiedad selected
                const optionToMove = option.cloneNode(true);
                destination.appendChild(optionToMove);
                
                // Remover del origen
                option.remove();
                
                // Actualizar el array de disponibles
                if (source === chosenSelect) {
                    // Si se mueve de inscritos a disponibles, agregarlo al array
                    todasLasOpcionesDisponibles.push(optionClone);
                } else {
                    // Si se mueve de disponibles a inscritos, quitarlo del array
                    todasLasOpcionesDisponibles = todasLasOpcionesDisponibles.filter(
                        opt => opt.value !== optionToMove.value
                    );
                }
            });
            
            // Reordenar alfab√©ticamente
            sortSelectOptions(destination);
            if (source === chosenSelect) {
                sortSelectOptions(availableSelect);
            }
            
            // CR√çTICO: Despu√©s de mover, mantener seleccionadas las del lado derecho
            mantenerSeleccionadas();
        }

        function sortSelectOptions(selectElement) {
            const options = Array.from(selectElement.options);
            options.sort((a, b) => a.text.localeCompare(b.text));
            selectElement.innerHTML = '';
            options.forEach(opt => selectElement.appendChild(opt));
        }

        btnAdd.addEventListener('click', () => moveOptions(availableSelect, chosenSelect));
        btnRemove.addEventListener('click', () => moveOptions(chosenSelect, availableSelect));
        
        // Mantener seleccionadas al hacer clic en cualquier parte
        chosenSelect.addEventListener('click', mantenerSeleccionadas);
        
        // CR√çTICO: Seleccionar todo antes de enviar el formulario
        if (form) {
            form.addEventListener('submit', function(e) {
                console.log('üì§ Enviando formulario...');
                mantenerSeleccionadas();
                const total = chosenSelect.options.length;
                const seleccionadas = chosenSelect.selectedOptions.length;
                console.log(`‚úì Total inscritos: ${total} | Seleccionados: ${seleccionadas}`);
                
                // Mostrar brevemente feedback visual
                if (total > 0) {
                    chosenSelect.style.border = '2px solid #4CAF50';
                    setTimeout(() => {
                        chosenSelect.style.border = '';
                    }, 300);
                }
            });
        }
    }

    // --- FUNCI√ìN 2: FILTRO DE B√öSQUEDA (VERSI√ìN CORREGIDA) ---
    function setupFilter() {
        const searchInput = document.getElementById('student-search');
        const availableSelect = document.getElementById('available-students');
        if (!searchInput || !availableSelect) return;

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            // Limpiar el select
            availableSelect.innerHTML = '';
            
            // Filtrar y agregar las opciones que coincidan
            todasLasOpcionesDisponibles.forEach(option => {
                const optionText = option.textContent.toLowerCase();
                if (searchTerm === '' || optionText.includes(searchTerm)) {
                    // Clonar la opci√≥n para evitar problemas de referencia
                    const optionClone = option.cloneNode(true);
                    availableSelect.appendChild(optionClone);
                }
            });
        });
    }

    // --- ESTILIZAR EL INPUT DE CSV ---
    function setupStyledFileInput() {
        const fileInput = document.getElementById('id_estudiantes_csv');
        if (!fileInput) return;

        const fakeButton = document.createElement('label');
        fakeButton.className = 'btn-adjunto';
        fakeButton.innerHTML = '<i class="fas fa-file-csv"></i> <span>Seleccionar archivo CSV</span>';
        
        const fileNameSpan = document.createElement('span');
        fileNameSpan.style.marginLeft = '1rem';
        fileNameSpan.style.fontStyle = 'italic';
        fileNameSpan.style.opacity = '0.7';

        fileInput.parentElement.insertBefore(fakeButton, fileInput);
        fakeButton.appendChild(fileInput);
        fakeButton.parentElement.insertBefore(fileNameSpan, fakeButton.nextSibling);

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                fileNameSpan.textContent = this.files[0].name;
                fakeButton.querySelector('span').textContent = 'Cambiar archivo';
            } else {
                fileNameSpan.textContent = '';
                fakeButton.querySelector('span').textContent = 'Seleccionar archivo CSV';
            }
        });
    }

    // --- MANEJA LA PREVISUALIZACI√ìN AJAX CON PAGINACI√ìN ---
    function setupIdPreview() {
        const btnPreview = document.getElementById('btn-preview-ids');
        const idsTextarea = document.getElementById('id_estudiantes_por_id');
        const previewDiv = document.getElementById('preview-results');
        const chosenSelect = document.getElementById('id_estudiantes');
        const availableSelect = document.getElementById('available-students');

        if (!btnPreview) return;

        let todosLosEncontrados = [];
        let todosLosNoEncontrados = [];
        const resultadosPorPagina = 10;

        function renderizarPagina(page = 1) {
            const inicio = (page - 1) * resultadosPorPagina;
            const fin = inicio + resultadosPorPagina;
            
            const resultadosPagina = todosLosEncontrados.slice(inicio, fin);

            let html = '<h4>Estudiantes Encontrados:</h4>';
            if (resultadosPagina.length > 0) {
                html += '<ul>';
                resultadosPagina.forEach(user => {
                    html += `<li>${user.full_name} (${user.username}) - ID: ${user.numero_id}</li>`;
                });
                html += '</ul>';
            } else if (todosLosEncontrados.length === 0) {
                html += '<p>No se encontr√≥ ning√∫n estudiante con los IDs proporcionados.</p>';
            }

            if (page === 1 && todosLosNoEncontrados.length > 0) {
                html += `<p style="color: orange;">IDs no encontrados: ${todosLosNoEncontrados.join(', ')}</p>`;
            }

            const totalPaginas = Math.ceil(todosLosEncontrados.length / resultadosPorPagina);
            if (totalPaginas > 1) {
                html += '<div class="pagination-controls" style="margin-top: 1em;">';
                if (page > 1) {
                    html += `<button type="button" class="btn-page" data-page="${page - 1}">&laquo; Anterior</button> `;
                }
                html += `<span>P√°gina ${page} de ${totalPaginas}</span>`;
                if (page < totalPaginas) {
                    html += ` <button type="button" class="btn-page" data-page="${page + 1}">Siguiente &raquo;</button>`;
                }
                html += '</div>';
            }
            
            previewDiv.innerHTML = html;
        }

        function buscarEstudiantes() {
            const ids = idsTextarea.value;
            const organizacionPk = "{{ object.organizacion.pk|default:request.user.profile.organizacion.pk }}";
            
            if (!ids.trim()) {
                previewDiv.innerHTML = '<p style="color: orange;">Por favor, introduce al menos un ID.</p>';
                return;
            }
            previewDiv.innerHTML = '<p>Buscando...</p>';

            fetch("{% url 'users:find_students_by_id' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ ids: ids, organizacion_pk: organizacionPk })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    previewDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                    return;
                }
                
                todosLosEncontrados = data.encontrados;
                todosLosNoEncontrados = data.no_encontrados;

                // A√±adir autom√°ticamente TODOS los encontrados a la caja de inscritos
                todosLosEncontrados.forEach(user => {
                    if (!chosenSelect.querySelector(`option[value="${user.id}"]`)) {
                        const option = new Option(`${user.full_name} (${user.username}) - ID: ${user.numero_id}`, user.id);
                        chosenSelect.appendChild(option);
                        
                        // Remover de disponibles si existe
                        const availableOption = availableSelect.querySelector(`option[value="${user.id}"]`);
                        if (availableOption) {
                            availableOption.remove();
                            // Actualizar el array de disponibles
                            todasLasOpcionesDisponibles = todasLasOpcionesDisponibles.filter(
                                opt => opt.value !== user.id.toString()
                            );
                        }
                    }
                });

                // IMPORTANTE: Mantener todas las opciones seleccionadas
                mantenerSeleccionadas();

                renderizarPagina(1);
            })
            .catch(error => {
                previewDiv.innerHTML = `<p style="color: red;">Error de red: ${error.message}</p>`;
            });
        }

        btnPreview.addEventListener('click', buscarEstudiantes);

        previewDiv.addEventListener('click', function(event) {
            if (event.target && event.target.classList.contains('btn-page')) {
                const page = parseInt(event.target.dataset.page, 10);
                renderizarPagina(page);
            }
        });
    }

    // --- FUNCI√ìN 3: MANEJA LA VISUALIZACION DE CSV ---
    function setupCsvPreview() {
        const btnPreview = document.getElementById('btn-preview-csv');
        const fileInput = document.getElementById('id_estudiantes_csv');
        const previewDiv = document.getElementById('csv-preview-results');
        const chosenSelect = document.getElementById('id_estudiantes');
        const availableSelect = document.getElementById('available-students');

        if (!btnPreview) return;

        function fetchCsvPreview() {
            if (fileInput.files.length === 0) {
                previewDiv.innerHTML = '<p style="color: orange;">Por favor, selecciona un archivo CSV primero.</p>';
                return;
            }

            const file = fileInput.files[0];
            const organizacionPk = "{{ object.organizacion.pk|default:request.user.profile.organizacion.pk }}";
            
            const formData = new FormData();
            formData.append('estudiantes_csv', file);
            formData.append('organizacion_pk', organizacionPk);

            previewDiv.innerHTML = '<p>Procesando archivo...</p>';

            fetch("{% url 'users:preview_students_csv' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    previewDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                    return;
                }
                
                let html = '<h4>Estudiantes Encontrados en CSV:</h4>';
                if (data.encontrados.length > 0) {
                    html += '<ul>';
                    data.encontrados.forEach(user => {
                        html += `<li>${user.full_name} - ID: ${user.numero_id}</li>`;
                        if (!chosenSelect.querySelector(`option[value="${user.id}"]`)) {
                            const option = new Option(`${user.full_name} (${user.username}) - ID: ${user.numero_id}`, user.id);
                            chosenSelect.appendChild(option);
                            
                            // Remover de disponibles si existe
                            const availableOption = availableSelect.querySelector(`option[value="${user.id}"]`);
                            if (availableOption) {
                                availableOption.remove();
                                todasLasOpcionesDisponibles = todasLasOpcionesDisponibles.filter(
                                    opt => opt.value !== user.id.toString()
                                );
                            }
                        }
                    });
                    html += '</ul>';
                    
                    // IMPORTANTE: Mantener todas las opciones seleccionadas
                    mantenerSeleccionadas();
                } else {
                    html += '<p>No se encontraron estudiantes.</p>';
                }

                if (data.no_encontrados.length > 0) {
                    html += `<p style="color: orange;">IDs no encontrados en CSV: ${data.no_encontrados.join(', ')}</p>`;
                }
                previewDiv.innerHTML = html;
            })
            .catch(error => {
                previewDiv.innerHTML = `<p style="color: red;">Error de red: ${error.message}</p>`;
            });
        }

        btnPreview.addEventListener('click', fetchCsvPreview);
    }

    // INICIALIZAR TODAS LAS FUNCIONES EN EL ORDEN CORRECTO
    setupStudentSelector();
    setupFilter();
    setupStyledFileInput();
    setupIdPreview();
    setupCsvPreview();
});
</script>

{% endblock %}