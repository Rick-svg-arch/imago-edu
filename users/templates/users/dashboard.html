{% extends 'layout.html' %}
{% load auth_extras %}

{% block content %}
<div class="container">
    <div style="text-align: center; margin-bottom: 3rem;">
        <h1>Panel de Control</h1>
        <p>Bienvenido de nuevo, {{ user.get_full_name|default:user.username }}.</p>
    </div>

    <div class="dashboard-grid">
        
        <!-- WIDGET DE PERFIL -->
        <div class="dashboard-widget">
            <h2><i class="fas fa-user-circle"></i> Mi Perfil</h2>
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <img src="{{ profile.avatar.url }}" alt="Avatar" width="120" class="current-avatar">
            </div>
            <p><strong>Organización:</strong> {{ profile.organizacion.nombre }}</p>
            <p><strong>Usuario:</strong> {{ user.username }}</p>
            <p><strong>Email:</strong> {{ user.email }}</p>
            <div class="respuesta-acciones" style="margin-top: 1.5rem;">
                <a href="{% url 'users:profile_edit' %}"><i class="fas fa-edit"></i> Editar perfil</a>
                <a href="{% url 'users:password_change' %}"><i class="fas fa-key"></i> Cambiar contraseña</a>
            </div>
        </div>

        <!-- WIDGET DE CLASES (PARA CUALQUIER ROL) -->
        {% if user|has_group:"Profesor" or user|has_group:"Administrativo" %}
            <div class="dashboard-widget">
                <h2><i class="fas fa-chalkboard-teacher"></i> Gestión de Clases</h2>
                <ul>
                {% if user|has_group:"Administrativo" %}
                    <!-- Los Admins ven TODAS las clases -->
                    {% for clase in todas_las_clases %}
                        <li>
                            <a href="{% url 'users:clase_detail' pk=clase.pk %}"><strong>{{ clase.nombre }}</strong></a>
                            <small>(Prof. {{ clase.profesor.get_full_name|default:clase.profesor.username }})</small>
                            <small>({{ clase.estudiantes.count }})</small>
                            <a href="{% url 'users:class_edit' pk=clase.pk %}" style="font-size: 0.8em; margin-left: 0.5em;">(Editar)</a>
                        </li>
                    {% empty %}
                        <li>Aún no hay clases en la organización.</li>
                    {% endfor %}
                {% else %}
                    <!-- Los Profesores solo ven las suyas -->
                    {% for clase in clases_dirigidas %}
                         <li>
                            <a href="{% url 'users:clase_detail' pk=clase.pk %}"><strong>{{ clase.nombre }}</strong></a>
                            <small>({{ clase.estudiantes.count }} estudiantes)</small>
                            <a href="{% url 'users:class_edit' pk=clase.pk %}" style="font-size: 0.8em; margin-left: 0.5em;">(Editar)</a>
                        </li>
                    {% empty %}
                        <li>No tienes clases asignadas.</li>
                    {% endfor %}
                {% endif %}
                </ul>
                <div style="margin-top: 1.5rem;">
                    <a href="{% url 'users:class_create' %}" class="submit-btn" style="width: 100%; justify-content: center;">
                        <i class="fas fa-plus"></i> Crear Nueva Clase
                    </a>
                </div>
            </div>
        {% elif user|has_group:"Estudiante" %}
            <!-- Widget para Estudiantes (lógica separada) -->
            <div class="dashboard-widget">
                 <h2><i class="fas fa-school"></i> Mis Clases</h2>
                 <ul>
                 {% for clase in user.clases_inscritas.all %}
                     <li>
                         <a href="{% url 'users:clase_detail' pk=clase.pk %}">{{ clase.nombre }}</a>
                         <small>(Prof. {{ clase.profesor.get_full_name|default:clase.profesor.username }})</small>
                     </li>
                 {% empty %}
                     <li>No estás inscrito en ninguna clase.</li>
                 {% endfor %}
                 </ul>
            </div>
        {% endif %}

        <!-- WIDGET ADMINISTRATIVO (SOLO PARA ADMINS) -->
        {% if user|has_group:"Administrativo" %}
            <div class="dashboard-widget">
                <h2><i class="fas fa-cogs"></i> Panel Administrativo</h2>
                <p>Gestiona todos los aspectos de la organización.</p>
                <ul>
                    <li><a href="{% url 'users:manage_users_list' %}"><i class="fas fa-users-cog"></i> Gestionar Roles de Usuario</a></li>
                    <li><a href="{% url 'users:manage_preregistros_list' %}"><i class="fas fa-list-alt"></i> Gestionar Pre-registro</a></li>
                    <li><a href="{% url 'users:historial_importaciones' %}"><i class="fas fa-history"></i> Historial de Importaciones</a></li>
                </ul>
            </div>
        {% endif %}
    </div>
    <div class="danger-zone" style="border: 2px solid #79363cff; border-radius: 12px; padding: 1.5rem; text-align: center;">
        <h3 style="color: #79363cff, margin-top: 0;">Zona de Peligro</h3>
        <p>La siguiente acción es irreversible. Por favor, asegúrate de lo que estás haciendo.</p>
        <a href="{% url 'users:borrar_cuenta' %}" class="submit-btn" style="background-color: #79363cff; border-color: #79363cff; display: inline-block; margin-top: 1rem;">
            <i class="fas fa-user-slash"></i> Desactivar mi Cuenta Permanentemente
        </a>
    </div>
</div>
{% endblock %}